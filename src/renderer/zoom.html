<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zoom View - AI Screen Helper</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #00ffff;
      overflow: hidden;
    }

    .header {
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      border-bottom: 1px solid #00ffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cell-info {
      font-size: 14px;
    }

    .instructions {
      font-size: 12px;
      opacity: 0.8;
    }

    .zoom-container {
      position: relative;
      width: 100%;
      height: calc(100vh - 60px);
      display: flex;
      flex-direction: column;
    }

    .zoom-canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .zoom-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    .fine-grid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .grid-square {
      position: absolute;
      border: 1px solid rgba(255, 255, 0, 0.3);
      background: rgba(255, 255, 0, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 15;
      pointer-events: all;
    }

    .grid-square:hover {
      background: rgba(255, 255, 0, 0.2);
      border-color: rgba(255, 255, 0, 0.8);
      box-shadow: 0 0 8px rgba(255, 255, 0, 0.4);
      transform: scale(1.02);
    }

    .grid-square.clicked {
      background: rgba(255, 0, 0, 0.3);
      border-color: rgba(255, 0, 0, 1);
      box-shadow: 0 0 12px rgba(255, 0, 0, 0.6);
    }

    .coordinate-display {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #00ffff;
      font-size: 14px;
      font-weight: bold;
    }

    .action-buttons {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
    }

    .btn {
      background: rgba(0, 255, 255, 0.2);
      border: 1px solid #00ffff;
      color: #00ffff;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: rgba(0, 255, 255, 0.4);
    }

    .btn.primary {
      background: rgba(0, 255, 255, 0.4);
    }

    .btn.primary:hover {
      background: rgba(0, 255, 255, 0.6);
    }

    .debug-indicator {
      position: absolute;
      top: 80px;
      left: 10px;
      background: rgba(255, 165, 0, 0.9);
      color: #000;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
      display: none;
      border: 1px solid #ff8c00;
    }

    .crosshair {
      position: absolute;
      pointer-events: none;
      z-index: 20;
    }

    .crosshair::before,
    .crosshair::after {
      content: '';
      position: absolute;
      background: #ff0000;
    }

    .crosshair::before {
      width: 100vw;
      height: 1px;
      top: 0;
      left: -50vw;
    }

    .crosshair::after {
      width: 1px;
      height: 100vh;
      top: -50vh;
      left: 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="cell-info" id="cellInfo">
      Cell: - | Area: -
    </div>
    <div style="display: flex; align-items: center; gap: 15px;">
      <div class="instructions">
        Click grid squares to close window and execute click
      </div>
      <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer;">
        <input type="checkbox" id="debugMode" style="margin: 0;">
        <span>Debug Mode (move only, keep open)</span>
      </label>
    </div>
  </div>

  <div class="zoom-container">
    <div class="zoom-canvas-container">
      <canvas class="zoom-canvas" id="zoomCanvas"></canvas>
      <svg class="fine-grid" id="fineGrid">
        <!-- Fine grid lines will be generated by JavaScript -->
      </svg>
      <div id="gridSquareContainer">
        <!-- Interactive grid squares will be generated here -->
      </div>
      <div class="crosshair" id="crosshair" style="display: none;"></div>
      <div class="debug-indicator" id="debugIndicator">
        üêõ DEBUG MODE: Click squares will only move mouse (no clicking)
      </div>
    </div>

    <div class="coordinate-display" id="coordinateDisplay">
      Mouse: (0, 0) | Screen: (0, 0)
    </div>

    <div class="action-buttons">
      <button class="btn" id="testBtn">Test xdotool</button>
      <button class="btn" id="backBtn">Back to Grid</button>
      <button class="btn" id="closeBtn">Close</button>
      <button class="btn" id="selectBtn">Select Coordinates</button>
      <button class="btn primary" id="clickBtn">Click Here</button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let currentCellData = null;
    let currentScreenshot = null;
    let currentConfig = null;
    let currentScreenSize = null;
    let currentMousePos = { x: 0, y: 0 };
    let actualMousePos = { x: 0, y: 0 };

    const canvas = document.getElementById('zoomCanvas');
    const ctx = canvas.getContext('2d');
    const fineGrid = document.getElementById('fineGrid');
    const crosshair = document.getElementById('crosshair');

    function setupZoomView(data) {
      currentCellData = data.cellData;
      currentScreenshot = data.screenshot;
      currentConfig = data.config;
      currentScreenSize = data.screenSize;

      // Update cell info display
      document.getElementById('cellInfo').textContent = 
        `Cell: ${currentCellData.number} | Area: ${currentCellData.width}√ó${currentCellData.height}px`;

      drawZoomedArea();
      createFineGrid();
    }

    function drawZoomedArea() {
      if (!currentScreenshot || !currentCellData) return;

      const img = new Image();
      img.onload = function() {
        // Set canvas size
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        // Calculate source rectangle from the original screenshot
        const sourceX = currentCellData.x;
        const sourceY = currentCellData.y;
        const sourceWidth = currentCellData.width;
        const sourceHeight = currentCellData.height;

        // Draw the zoomed portion
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.imageSmoothingEnabled = false; // Pixelated zoom for precision
        ctx.drawImage(
          img,
          sourceX, sourceY, sourceWidth, sourceHeight,
          0, 0, canvas.width, canvas.height
        );
      };
      img.src = currentScreenshot;
    }

    function createFineGrid() {
      if (!currentCellData) return;

      fineGrid.innerHTML = '';
      const gridSquareContainer = document.getElementById('gridSquareContainer');
      gridSquareContainer.innerHTML = '';
      
      const gridSize = 20; // 20x20 pixel grid
      const canvasRect = canvas.getBoundingClientRect();
      
      // Create vertical lines
      for (let i = 0; i <= currentCellData.width; i += gridSize) {
        const x = (i / currentCellData.width) * canvasRect.width;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x);
        line.setAttribute('y1', 0);
        line.setAttribute('x2', x);
        line.setAttribute('y2', canvasRect.height);
        line.setAttribute('stroke', 'rgba(0, 255, 255, 0.3)');
        line.setAttribute('stroke-width', '1');
        fineGrid.appendChild(line);
      }

      // Create horizontal lines
      for (let i = 0; i <= currentCellData.height; i += gridSize) {
        const y = (i / currentCellData.height) * canvasRect.height;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', 0);
        line.setAttribute('y1', y);
        line.setAttribute('x2', canvasRect.width);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', 'rgba(0, 255, 255, 0.3)');
        line.setAttribute('stroke-width', '1');
        fineGrid.appendChild(line);
      }

      // Create interactive grid squares and add grid numbers
      const gridCols = Math.ceil(currentCellData.width / gridSize);
      const gridRows = Math.ceil(currentCellData.height / gridSize);
      
      for (let row = 0; row < gridRows; row++) {
        for (let col = 0; col < gridCols; col++) {
          // Create clickable grid square
          const square = document.createElement('div');
          square.className = 'grid-square';
          
          const squareLeft = (col * gridSize / currentCellData.width) * canvasRect.width;
          const squareTop = (row * gridSize / currentCellData.height) * canvasRect.height;
          const squareWidth = (gridSize / currentCellData.width) * canvasRect.width;
          const squareHeight = (gridSize / currentCellData.height) * canvasRect.height;
          
          square.style.left = squareLeft + 'px';
          square.style.top = squareTop + 'px';
          square.style.width = squareWidth + 'px';
          square.style.height = squareHeight + 'px';
          
          // Calculate center coordinates for this grid square
          const centerX = Math.floor(currentCellData.x + (col + 0.5) * gridSize);
          const centerY = Math.floor(currentCellData.y + (row + 0.5) * gridSize);
          
          square.title = `Click to move and click at (${centerX}, ${centerY})`;
          
          square.addEventListener('click', (event) => {
            event.stopPropagation();
            executeClick(centerX, centerY, square);
          });
          
          gridSquareContainer.appendChild(square);
          
          // Add grid number text
          const textX = squareLeft + 5;
          const textY = squareTop + 15;
          
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', textX);
          text.setAttribute('y', textY);
          text.setAttribute('fill', 'rgba(255, 255, 255, 0.6)');
          text.setAttribute('font-size', '10');
          text.setAttribute('font-family', 'monospace');
          text.textContent = `${col},${row}`;
          fineGrid.appendChild(text);
        }
      }
    }

    function executeClick(x, y, squareElement) {
      // Visual feedback (brief)
      squareElement.classList.add('clicked');
      
      const debugMode = document.getElementById('debugMode').checked;
      
      if (debugMode) {
        console.log(`üêõ DEBUG: Only moving mouse to (${x}, ${y}) - no click`);
        ipcRenderer.send('debug-move-mouse', {
          x: x,
          y: y,
          cellNumber: currentCellData.number,
          debugMode: true
        });
        // Keep zoom window open in debug mode for testing
        setTimeout(() => {
          squareElement.classList.remove('clicked');
        }, 500);
      } else {
        console.log(`üñ±Ô∏è EXECUTING: Move and click at (${x}, ${y}) - preparing to close zoom window`);
        
        // First, notify main process that we're about to execute
        ipcRenderer.send('prepare-execute', {
          x: x,
          y: y,
          cellNumber: currentCellData.number
        });
        
        // Close zoom window immediately to avoid interference
        window.close();
      }
    }

    // Mouse tracking
    canvas.addEventListener('mousemove', (event) => {
      const rect = canvas.getBoundingClientRect();
      const canvasX = event.clientX - rect.left;
      const canvasY = event.clientY - rect.top;

      // Calculate relative position within the cell
      const relativeX = (canvasX / rect.width) * currentCellData.width;
      const relativeY = (canvasY / rect.height) * currentCellData.height;

      // Calculate actual screen coordinates
      actualMousePos.x = Math.floor(currentCellData.x + relativeX);
      actualMousePos.y = Math.floor(currentCellData.y + relativeY);

      currentMousePos.x = Math.floor(canvasX);
      currentMousePos.y = Math.floor(canvasY);

      // Update coordinate display
      document.getElementById('coordinateDisplay').textContent = 
        `Mouse: (${currentMousePos.x}, ${currentMousePos.y}) | Screen: (${actualMousePos.x}, ${actualMousePos.y})`;

      // Update crosshair
      crosshair.style.display = 'block';
      crosshair.style.left = canvasX + 'px';
      crosshair.style.top = canvasY + 'px';
    });

    canvas.addEventListener('mouseleave', () => {
      crosshair.style.display = 'none';
    });

    // Canvas click disabled - using grid squares instead
    // canvas.addEventListener('click', () => {
    //   // Grid squares handle clicking now
    // });

    function selectCoordinates(executeClick = false) {
      const coordinateData = {
        x: actualMousePos.x,
        y: actualMousePos.y,
        cellNumber: currentCellData.number,
        executeClick: executeClick
      };

      ipcRenderer.send('coordinate-selected', coordinateData);
      
      if (!executeClick) {
        // Just log the coordinates
        console.log(`Selected coordinates: (${coordinateData.x}, ${coordinateData.y})`);
      }
    }

    function debugClickCoordinates() {
      const coordinateData = {
        x: actualMousePos.x,
        y: actualMousePos.y,
        cellNumber: currentCellData.number,
        executeClick: false, // Don't click, just move for debugging
        debugMode: true
      };

      console.log(`üêõ DEBUG MODE: Moving mouse to (${coordinateData.x}, ${coordinateData.y})`);
      ipcRenderer.send('debug-move-mouse', coordinateData);
    }

    // Button handlers
    document.getElementById('testBtn').addEventListener('click', () => {
      console.log('üß™ Testing xdotool functionality...');
      ipcRenderer.send('test-xdotool');
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      ipcRenderer.send('show-overlay-again');
      window.close();
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
      window.close();
    });

    document.getElementById('selectBtn').addEventListener('click', () => {
      selectCoordinates(false);
    });

    document.getElementById('clickBtn').addEventListener('click', () => {
      selectCoordinates(true);
      window.close();
    });

    // Handle zoom data from main process
    ipcRenderer.on('show-zoom', (event, data) => {
      setupZoomView(data);
    });

    // Handle debug mode checkbox
    document.getElementById('debugMode').addEventListener('change', (event) => {
      const debugIndicator = document.getElementById('debugIndicator');
      if (event.target.checked) {
        debugIndicator.style.display = 'block';
        console.log('üêõ DEBUG MODE ENABLED: Clicks will execute xdotool mousemove commands');
      } else {
        debugIndicator.style.display = 'none';
        console.log('üêõ DEBUG MODE DISABLED: Normal coordinate selection mode');
      }
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      setTimeout(() => {
        drawZoomedArea();
        createFineGrid();
      }, 100);
    });
  </script>
</body>
</html>